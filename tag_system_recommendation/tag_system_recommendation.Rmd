---
title: "Tag based TF-IDF"
author: "Haolin Zhong, Shaocong Zhang, Yuxuan Wang, Boqian Li"
date: "11/22/2021"
output: 
  html_document:
   code_folding: hide
---

```{r, echo=FALSE, message=FALSE, warning = FALSE}
library(tidyverse)
library(tm)
library(ggridges)
library(dplyr)
```

```{r, echo=FALSE, message=FALSE, warning = FALSE}
# data import
movies = read_csv("../data/small/movies.csv")
ratings = read_csv("../data/small/ratings.csv")
tags = read_csv("../data/small/tags.csv")
```

```{r, echo=FALSE, message=FALSE, warning = FALSE}
# data wrangling
tags.full = 
  tags %>%
  janitor::clean_names() %>%
  mutate(
    tag = strsplit(tag, " ")
  ) %>%
  unnest() %>% 
  mutate(tag = tolower(tag))

remove.list = read_csv("./stop_words_english.txt", col_names = FALSE) %>% 
  pull("X1") %>% 
  as_vector()

remove.tag = 
tags.full %>% 
  filter(!tag %in% remove.list) %>%
  mutate(
    tag = removePunctuation(tag)
  ) %>% 
  filter(
    !tag == ""
  )
```

Now we get the user tagging behavior data. The dataset contains user id, movie id, tag and time stamp (it represents seconds since midnight Coordinated Universal Time of January 1, 1970, but we will not use this variable in this part). Based on these information, we can construct a personalized recommendation algorithm by:

1. Count the most commonly used tags of the user.

2. For each tag, count the movies that have been labeled the most times.

3. For a user, first find his commonly used tags, and then find the most popular movies with these tags to recommend to the user.

For the above algorithm, the formula of user u's interest in movie i is as follows:

$p(u, i)=\sum_{b} \frac{n_{u, b}}{\log \left(1+n_{b}^{(u)}\right)} \frac{n_{b, i}}{\log \left(1+n_{i}^{(u)}\right)}$

where $B(u)$ is the set of tags that user u has labeled, $B(i)$ is the set of tags that movie i is labeled, $n_{u, b}$ is the number of times that user u has labeled tag b, $n_{b, i}$ is the number of times that movie i has been labeled tag b, $n_b^{(u)}$ records how many different users have used tag b, $n_i^{(u)}$records how many different users have tagged the movie i. To get the specific value, we should build our function first.

```{r, collapse = TRUE}
# Set up interest function
fc.interest = function(u, i) {
B.u = 
  remove.tag %>% 
  filter(user_id == u)

B.u.distinct = 
  B.u %>% 
  distinct(tag)

remove.tag.distinct = 
  remove.tag %>% 
  select(-movie_id, -timestamp) %>% 
  distinct()

B.i = 
  remove.tag %>% 
  filter(movie_id == i)

B.i.distinct = 
  B.i %>% 
  select(-tag, -timestamp) %>% 
  distinct()

n_ub = c()
n_bi = c()
n_bu = c()
lg.value = c()
n_iu = nrow(B.i.distinct)
value = c()

for (b in 1:nrow(B.u.distinct)) {
  n_ub[b] = sum(B.u$tag == as.character(B.u.distinct[b, 1]))
  n_bi[b] = sum(B.i$tag == as.character(B.u.distinct[b, 1]))
  n_bu[b] = sum(remove.tag.distinct$tag == as.character(B.u.distinct[b, 1]))
  lg.value[b] = log(1 + n_bu[b]) * log(1 + n_iu)
  value[b] = n_ub[b] * n_bi[b] / lg.value[b]
}
return(interest = round(sum(value), 2))
}
```

### Search the movie that was most frequently labeled by the users

After building the function, we want to select the most popular movie to see how this function works. Since the dataset we have only contains about 3700 tags labeled by the users, we will then choose several movies that have labeled most by users. In this way, we select the movies that has labeled by more than 4 users. For example, Star Wars: Episode IV - A New Hope.


<img src="starwar.jpg" style="width:75%">   

```{r}
popular.movie = 
  remove.tag %>% 
  select(-tag, -timestamp) %>% 
  distinct() %>%
  group_by(movie_id) %>% 
  summarize(
    count = n()
  ) %>% 
  filter(count > 3) %>% 
  mutate(
    "movie id" = movie_id
  ) %>% 
  select(-movie_id) %>% 
  select("movie id", count) %>% 
  arrange(desc(count))

active.user = 
  remove.tag %>% 
  select(-tag, -timestamp) %>%
  distinct() %>% 
  group_by(user_id) %>% 
  summarize(
    count = n()
  ) %>% 
  filter(count > 20) %>% 
  arrange(desc(count))

active.user.vec = as.vector(active.user$user_id)
popular.movie.vec = as.vector(popular.movie$`movie id`)

movie.name = 
  movies %>% 
  janitor::clean_names() %>%
  filter(movie_id %in% popular.movie.vec) %>% 
  knitr::kable()

movie.name
```

### Create heat map

After having the movie list that we want to further investigate, we will then randomly select 30 users to create a heat map for visualization.

```{r}

# construct a new table of the selected id and movie
heat.map = tibble(user_id = rep(active.user.vec, length(popular.movie.vec)), movie_id = rep(popular.movie.vec, length(active.user.vec)))

# add insterest value to the table
interest = c()
for (i in 1:nrow(heat.map)) {
  interest[i] = fc.interest(as.numeric(heat.map[i, 1]), as.numeric(heat.map[i, 2]))
}

heat.map = add_column(heat.map, interest)

# build heat map
heat.map %>% 
  ggplot(aes(y = as.factor(user_id), x = as.factor(movie_id), fill = interest)) +
  geom_tile() +
  geom_raster() +
  labs(
    x = "Movie ID",
    y = "User ID"
  )

```









